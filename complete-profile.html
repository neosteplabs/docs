import { auth, db } from "./firebase-config.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const saveBtn = document.getElementById("saveProfile");

/* =========================
   Generate NS Referral Code
========================= */
function generateReferralCode() {
  const random = Math.floor(1000 + Math.random() * 9000);
  return `NS${random}`;
}

/* =========================
   Auth Guard
========================= */
onAuthStateChanged(auth, async (user) => {

  if (!user) {
    window.location.href = "index.html";
    return;
  }

  const userRef = doc(db, "users", user.uid);
  const userSnap = await getDoc(userRef);

  saveBtn?.addEventListener("click", async () => {

    const fullName = document.getElementById("fullName").value;
    const phone = document.getElementById("phone").value;

    const address1 = document.getElementById("address1").value;
    const address2 = document.getElementById("address2").value;
    const city = document.getElementById("city").value;
    const state = document.getElementById("state").value;
    const zip = document.getElementById("zip").value;

    const referralInput = document.getElementById("referralCode")?.value || "";

    if (!fullName || !phone || !address1 || !city || !state || !zip) {
      alert("Please complete all required fields.");
      return;
    }

    let referralCodeToSave;

    // If user already has a referral code, keep it
    if (userSnap.exists() && userSnap.data().referralCode) {
      referralCodeToSave = userSnap.data().referralCode;
    } else {
      referralCodeToSave = generateReferralCode();
    }

    const profileData = {
      fullName,
      phone,
      address1,
      address2,
      city,
      state,
      zip,
      referralUsed: referralInput || null,
      referralCode: referralCodeToSave,
      profileComplete: true,
      createdAt: userSnap.exists() ? userSnap.data().createdAt : serverTimestamp()
    };

    await setDoc(userRef, profileData, { merge: true });

    window.location.href = "catalog.html";

  });

});